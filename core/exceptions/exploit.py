"""
AutoRedTeam-Orchestrator 漏洞利用异常

漏洞利用、C2通信、横向移动相关的错误类型定义。
"""

from __future__ import annotations

from typing import Any, Optional

from .base import AutoRedTeamError

# ============================================================================
# 漏洞利用错误
# ============================================================================


class ExploitError(AutoRedTeamError):
    """
    漏洞利用错误基类

    漏洞利用过程中的错误。

    属性:
        vuln_type: 漏洞类型
        exploit_name: 利用程序名称
    """

    def __init__(
        self,
        message: str,
        vuln_type: Optional[str] = None,
        exploit_name: Optional[str] = None,
        **kwargs: Any,
    ):
        """
        初始化漏洞利用错误

        参数:
            message: 错误消息
            vuln_type: 漏洞类型（如 SQLi, RCE）
            exploit_name: 利用程序名称
            **kwargs: 传递给父类的其他参数
        """
        super().__init__(message, **kwargs)
        self.vuln_type = vuln_type
        self.exploit_name = exploit_name
        if vuln_type:
            self.details["vuln_type"] = vuln_type
        if exploit_name:
            self.details["exploit"] = exploit_name


class ExploitFailed(ExploitError):
    """
    利用失败

    当漏洞利用尝试未能成功时抛出。

    示例:
        >>> raise ExploitFailed("利用条件不满足", vuln_type="SQLi", details={"reason": "WAF拦截"})
    """

    pass


class PayloadDeliveryFailed(ExploitError):
    """
    Payload投递失败

    当Payload无法成功发送到目标时抛出。

    示例:
        >>> raise PayloadDeliveryFailed("Payload被过滤", details={"filter": "WAF", "payload_size": 1024})
    """

    pass


class ShellError(ExploitError):
    """
    Shell错误

    当获取/维持Shell连接失败时抛出。

    示例:
        >>> raise ShellError("反向Shell连接失败", details={"lhost": "10.0.0.1", "lport": 4444})
    """

    pass


# ============================================================================
# C2错误
# ============================================================================


class C2Error(AutoRedTeamError):
    """
    C2通信错误基类

    Command & Control 通信过程中的错误。

    属性:
        c2_server: C2服务器地址
        beacon_id: Beacon标识符
    """

    def __init__(
        self,
        message: str,
        c2_server: Optional[str] = None,
        beacon_id: Optional[str] = None,
        **kwargs: Any,
    ):
        """
        初始化C2错误

        参数:
            message: 错误消息
            c2_server: C2服务器地址
            beacon_id: Beacon标识符
            **kwargs: 传递给父类的其他参数
        """
        super().__init__(message, **kwargs)
        self.c2_server = c2_server
        self.beacon_id = beacon_id
        if c2_server:
            self.details["c2_server"] = c2_server
        if beacon_id:
            self.details["beacon_id"] = beacon_id


class BeaconError(C2Error):
    """
    Beacon错误

    当Beacon心跳失败、状态异常时抛出。

    示例:
        >>> raise BeaconError("Beacon心跳超时", beacon_id="beacon-001")
        >>> raise BeaconError("Beacon注册失败", details={"reason": "认证失败"})
    """

    pass


class TunnelError(C2Error):
    """
    隧道错误

    当隧道建立失败、隧道断开时抛出。

    属性:
        tunnel_type: 隧道类型（HTTP, DNS, WebSocket等）
    """

    def __init__(self, message: str, tunnel_type: Optional[str] = None, **kwargs: Any):
        """
        初始化隧道错误

        参数:
            message: 错误消息
            tunnel_type: 隧道类型
            **kwargs: 传递给父类的其他参数
        """
        super().__init__(message, **kwargs)
        self.tunnel_type = tunnel_type
        if tunnel_type:
            self.details["tunnel_type"] = tunnel_type


class EncryptionError(C2Error):
    """
    加密错误

    当加密/解密失败、密钥交换失败时抛出。

    示例:
        >>> raise EncryptionError("密钥协商失败")
        >>> raise EncryptionError("解密失败", details={"algorithm": "AES-256-GCM"})
    """

    pass


# ============================================================================
# 横向移动错误
# ============================================================================


class LateralError(AutoRedTeamError):
    """
    横向移动错误基类

    横向移动过程中的错误。

    属性:
        source_host: 源主机
        target_host: 目标主机
    """

    def __init__(
        self,
        message: str,
        source_host: Optional[str] = None,
        target_host: Optional[str] = None,
        **kwargs: Any,
    ):
        """
        初始化横向移动错误

        参数:
            message: 错误消息
            source_host: 源主机地址
            target_host: 目标主机地址
            **kwargs: 传递给父类的其他参数
        """
        super().__init__(message, **kwargs)
        self.source_host = source_host
        self.target_host = target_host
        if source_host:
            self.details["source"] = source_host
        if target_host:
            self.details["target"] = target_host


class SMBError(LateralError):
    """
    SMB错误

    SMB协议操作失败时抛出。

    示例:
        >>> raise SMBError("SMB认证失败", target_host="192.168.1.10")
        >>> raise SMBError("共享访问被拒绝", details={"share": "C$"})
    """

    pass


class SSHError(LateralError):
    """
    SSH错误

    SSH连接或操作失败时抛出。

    示例:
        >>> raise SSHError("SSH认证失败", target_host="10.0.0.5")
        >>> raise SSHError("密钥认证失败", details={"key_type": "RSA"})
    """

    pass


class WMIError(LateralError):
    """
    WMI错误

    WMI操作失败时抛出。

    示例:
        >>> raise WMIError("WMI连接失败", target_host="192.168.1.20")
        >>> raise WMIError("WMI查询执行失败", details={"query": "SELECT * FROM Win32_Process"})
    """

    pass


__all__ = [
    # 漏洞利用错误
    "ExploitError",
    "ExploitFailed",
    "PayloadDeliveryFailed",
    "ShellError",
    # C2错误
    "C2Error",
    "BeaconError",
    "TunnelError",
    "EncryptionError",
    # 横向移动错误
    "LateralError",
    "SMBError",
    "SSHError",
    "WMIError",
]
