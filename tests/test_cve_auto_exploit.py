#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CVE 自动利用引擎测试

测试内容:
1. AI PoC Generator 集成
2. CVE 搜索与信息提取
3. 自动利用流程
4. 错误处理
"""

import pytest
import asyncio
from unittest.mock import Mock, patch, MagicMock
from pathlib import Path
import tempfile

# 模块级别标记 - 标识为单元测试和安全测试
pytestmark = [pytest.mark.unit, pytest.mark.security]


class TestAIPoCGenerator:
    """AI PoC Generator 测试"""

    def test_import_ai_poc_generator(self):
        """测试导入 AI PoC 生成器"""
        from core.cve.ai_poc_generator import AIPoCGenerator, VulnType
        assert AIPoCGenerator is not None
        assert VulnType is not None

    def test_vuln_type_identification(self):
        """测试漏洞类型识别"""
        from core.cve.ai_poc_generator import KeywordMatcher, VulnType

        # SQL 注入
        assert KeywordMatcher.identify_vuln_type(
            "SQL injection vulnerability in the login form"
        ) == VulnType.SQL_INJECTION

        # XSS
        assert KeywordMatcher.identify_vuln_type(
            "Cross-site scripting (XSS) via the search parameter"
        ) == VulnType.XSS

        # RCE
        assert KeywordMatcher.identify_vuln_type(
            "Remote code execution allows attackers to run arbitrary code"
        ) == VulnType.RCE

        # 未知类型
        assert KeywordMatcher.identify_vuln_type(
            "Some generic security issue"
        ) == VulnType.UNKNOWN

    def test_generate_poc_sqli(self):
        """测试 SQL 注入 PoC 生成"""
        from core.cve.ai_poc_generator import generate_poc

        poc = generate_poc(
            cve_id="CVE-2024-TEST1",
            cve_description="SQL injection vulnerability in WordPress Plugin allows remote attackers to execute SQL commands via the id parameter",
            severity="high"
        )

        assert poc is not None
        assert "CVE-2024-TEST1" in poc
        assert "sqli" in poc.lower() or "sql" in poc.lower()

    def test_generate_poc_xss(self):
        """测试 XSS PoC 生成"""
        from core.cve.ai_poc_generator import generate_poc

        poc = generate_poc(
            cve_id="CVE-2024-TEST2",
            cve_description="Cross-site scripting (XSS) vulnerability allows attackers to inject JavaScript",
            severity="medium"
        )

        assert poc is not None
        assert "CVE-2024-TEST2" in poc
        assert "xss" in poc.lower() or "script" in poc.lower()

    def test_generate_poc_rce(self):
        """测试 RCE PoC 生成"""
        from core.cve.ai_poc_generator import generate_poc

        poc = generate_poc(
            cve_id="CVE-2024-TEST3",
            cve_description="Remote code execution in Apache Struts allows arbitrary code execution",
            severity="critical"
        )

        assert poc is not None
        assert "CVE-2024-TEST3" in poc
        assert "rce" in poc.lower() or "code" in poc.lower()

    def test_cve_parser_extract_product(self):
        """测试产品名称提取"""
        from core.cve.ai_poc_generator import CVEParser

        product = CVEParser.extract_product(
            "SQL injection in WordPress Plugin Contact Form 7 version 5.8.1"
        )
        assert "WordPress" in product or "Contact Form" in product

    def test_cve_parser_extract_version(self):
        """测试版本号提取"""
        from core.cve.ai_poc_generator import CVEParser

        version = CVEParser.extract_version(
            "Vulnerability in Apache Tomcat version 9.0.50 before 9.0.51"
        )
        assert version in ("9.0.50", "9.0.51")


class TestCVEAutoExploitEngine:
    """CVE 自动利用引擎测试"""

    def test_import_auto_exploit(self):
        """测试导入自动利用模块"""
        from core.cve.auto_exploit import (
            CVEAutoExploitEngine,
            AutoExploitResult,
            AutoExploitStatus,
        )
        assert CVEAutoExploitEngine is not None
        assert AutoExploitResult is not None
        assert AutoExploitStatus is not None

    def test_auto_exploit_result_dataclass(self):
        """测试 AutoExploitResult 数据类"""
        from core.cve.auto_exploit import AutoExploitResult, AutoExploitStatus

        result = AutoExploitResult(
            status=AutoExploitStatus.SUCCESS,
            cve_id="CVE-2024-1234",
            target="https://example.com",
            vulnerable=True,
            evidence="Test evidence",
        )

        assert result.success is True
        assert result.cve_id == "CVE-2024-1234"

        # 测试 to_dict
        result_dict = result.to_dict()
        assert result_dict['status'] == 'success'
        assert result_dict['vulnerable'] is True

    def test_auto_exploit_result_add_step(self):
        """测试步骤添加"""
        from core.cve.auto_exploit import AutoExploitResult, AutoExploitStatus

        result = AutoExploitResult(
            status=AutoExploitStatus.ERROR,
            cve_id="CVE-2024-1234",
            target="https://example.com",
        )

        result.add_step('test_step', True, {'detail': 'test'})

        assert len(result.steps) == 1
        assert result.steps[0]['step'] == 'test_step'
        assert result.steps[0]['success'] is True

    def test_engine_initialization(self):
        """测试引擎初始化"""
        from core.cve.auto_exploit import CVEAutoExploitEngine

        engine = CVEAutoExploitEngine()

        assert engine.timeout == 60
        assert engine.verify_before_exploit is True
        assert engine.poc_template_dir.exists()

    def test_engine_extract_vuln_type(self):
        """测试漏洞类型提取"""
        from core.cve.auto_exploit import CVEAutoExploitEngine

        engine = CVEAutoExploitEngine()

        # 测试 SQL 注入
        vuln_type = engine._extract_vuln_type("SQL injection vulnerability")
        assert vuln_type == 'sqli'

        # 测试 XSS
        vuln_type = engine._extract_vuln_type("Cross-site scripting attack")
        assert vuln_type == 'xss'

        # 测试 RCE
        vuln_type = engine._extract_vuln_type("Remote code execution")
        assert vuln_type == 'rce'

    def test_generate_poc_only(self):
        """测试仅生成 PoC"""
        from core.cve.auto_exploit import CVEAutoExploitEngine

        engine = CVEAutoExploitEngine()
        poc = engine.generate_poc_only(
            cve_id="CVE-2024-TEST",
            description="SQL injection in login form",
            severity="high"
        )

        assert poc is not None
        assert "CVE-2024-TEST" in poc

    def test_save_poc_template(self):
        """测试 PoC 模板保存"""
        from core.cve.auto_exploit import CVEAutoExploitEngine

        with tempfile.TemporaryDirectory() as tmpdir:
            engine = CVEAutoExploitEngine(
                poc_template_dir=Path(tmpdir)
            )

            poc_yaml = "id: test-poc\ninfo:\n  name: Test"
            path = engine._save_poc_template("CVE-2024-TEST", poc_yaml)

            assert path.exists()
            assert path.read_text(encoding='utf-8') == poc_yaml


class TestCVEAutoExploitAsync:
    """CVE 自动利用异步测试"""

    @pytest.mark.asyncio
    async def test_exploit_with_description_no_target(self):
        """测试无目标漏洞时的响应"""
        from core.cve.auto_exploit import CVEAutoExploitEngine, AutoExploitStatus

        engine = CVEAutoExploitEngine()

        # 模拟 PoC 执行返回不存在漏洞
        with patch.object(engine, '_execute_poc', return_value={'vulnerable': False}):
            result = await engine.exploit_with_description(
                target="https://safe-site.com",
                cve_id="CVE-2024-TEST",
                description="SQL injection in login form",
                severity="high"
            )

        assert result.status == AutoExploitStatus.TARGET_NOT_VULNERABLE
        assert result.vulnerable is False

    @pytest.mark.asyncio
    async def test_exploit_with_description_poc_generation_failure(self):
        """测试 PoC 生成失败"""
        from core.cve.auto_exploit import CVEAutoExploitEngine, AutoExploitStatus

        engine = CVEAutoExploitEngine()

        # 模拟 PoC 生成失败
        with patch.object(engine, '_generate_poc', return_value=None):
            result = await engine.exploit_with_description(
                target="https://example.com",
                cve_id="CVE-2024-TEST",
                description="Some vulnerability",
            )

        assert result.status == AutoExploitStatus.POC_GENERATION_FAILED

    @pytest.mark.asyncio
    async def test_auto_exploit_by_cve_not_found(self):
        """测试 CVE 未找到"""
        from core.cve.auto_exploit import CVEAutoExploitEngine, AutoExploitStatus

        engine = CVEAutoExploitEngine()

        # 模拟 CVE 搜索返回空
        with patch.object(engine, '_search_cve', return_value=None):
            result = await engine.auto_exploit_by_cve(
                target="https://example.com",
                cve_id="CVE-9999-99999"
            )

        assert result.status == AutoExploitStatus.CVE_NOT_FOUND


class TestConvenienceFunctions:
    """便捷函数测试"""

    def test_get_auto_exploit_engine_singleton(self):
        """测试全局实例单例"""
        from core.cve.auto_exploit import get_auto_exploit_engine

        engine1 = get_auto_exploit_engine()
        engine2 = get_auto_exploit_engine()

        assert engine1 is engine2

    def test_generate_cve_poc_function(self):
        """测试便捷函数 generate_cve_poc"""
        from core.cve.auto_exploit import generate_cve_poc

        poc = generate_cve_poc(
            cve_id="CVE-2024-FUNC",
            description="Path traversal vulnerability",
            severity="medium"
        )

        assert poc is not None
        assert "CVE-2024-FUNC" in poc


class TestModuleExports:
    """模块导出测试"""

    def test_cve_module_exports(self):
        """测试 CVE 模块导出"""
        from core.cve import (
            # AI PoC 生成器
            AIPoCGenerator,
            VulnType,
            generate_poc,

            # 自动利用引擎
            CVEAutoExploitEngine,
            AutoExploitResult,
            AutoExploitStatus,
            get_auto_exploit_engine,
            auto_exploit_cve,
            exploit_cve_with_description,
            generate_cve_poc,
        )

        assert AIPoCGenerator is not None
        assert CVEAutoExploitEngine is not None
        assert auto_exploit_cve is not None


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
