#!/usr/bin/env python3
"""
路径遍历 exploiter 单元测试
"""

from core.exploit.exploiters.path_traversal_exploiter import PathTraversalExploiter
from core.detectors.result import DetectionResult, Severity


class DummyResponse:
    def __init__(self, text: str):
        self.text = text


class DummyClient:
    def __init__(self, text: str):
        self.text = text
        self.calls = []

    def get(self, url: str, params=None, timeout=None):
        self.calls.append(("GET", url, params, timeout))
        return DummyResponse(self.text)

    def post(self, url: str, data=None, timeout=None):
        self.calls.append(("POST", url, data, timeout))
        return DummyResponse(self.text)


def _make_detection(param: str = "file", payload: str = "../../../../etc/passwd"):
    return DetectionResult(
        vulnerable=True,
        vuln_type="path_traversal",
        severity=Severity.HIGH,
        url="https://example.com/download",
        param=param,
        payload=payload,
        evidence="root:x:0:0:",
        verified=True,
        extra={"os_type": "unix", "target_file": "/etc/passwd"},
    )


def test_path_traversal_exploiter_success():
    exploiter = PathTraversalExploiter()
    exploiter._http_client = DummyClient("root:x:0:0:root:/root:/bin/bash")

    detection = _make_detection()
    result = exploiter.exploit(detection, targets={"files": {"unix": ["/etc/passwd"]}})

    assert result.success is True
    assert result.files
    assert result.files[0].path == "/etc/passwd"
    assert exploiter._http_client.calls


def test_path_traversal_exploiter_missing_param():
    exploiter = PathTraversalExploiter()
    exploiter._http_client = DummyClient("root:x:0:0:")

    detection = _make_detection(param=None)
    result = exploiter.exploit(detection, targets={"files": {"unix": ["/etc/passwd"]}})

    assert result.status.value == "not_applicable"
